
rule install_nest:
    output:
        expand('{nest_folder}/instl/bin/nest_vars.sh',nest_folder=NEST_SRC_DIR)
    params:
        nest_dir=NEST_SRC_DIR,
    shell:
        """
        cd {params.nest_dir}
        mkdir -p bld
        mkdir -p instl
        cd bld
        cmake -DCMAKE_INSTALL_PREFIX:PATH={params.nest_dir}/instl -Dwith-python=ON {params.nest_dir}
        make -j8
        make install
        """

rule run_model:
    output:
        weights=expand("{folder}/{pre}_{file}",folder=NEST_DATA_DIR,file=WEIGHT_SAMPLES,pre=PREFIX),
        spikes=expand("{folder}/{pre}_{file}",folder=NEST_DATA_DIR,file=SPIKE_SAMPLES,pre=PREFIX)
    input:
        model='{folder}/model.py'.format(folder=NEST_CODE_DIR),
        nest=rules.install_nest.output
    shell:
        """
        source {{input.nest}}
        python {folder}/model.py -o {output_folder}
        """.format(folder=NEST_CODE_DIR,output_folder=os.path.join(CUR_DIR,NEST_DATA_DIR))


rule nest_single_neuron_test:
    input:
        model='{folder}/model.py'.format(folder=NEST_CODE_DIR),
        nest=rules.install_nest.output,
        repro= expand('{folder}/reformat_single_stim_all_01.json',folder=IZHI_DATA_DIR),
        stim=rules.original_single_neuron_test.output.stim,
    output:
        mem='{folder}/NEST_single_stim-2002-0.dat'.format(folder=NEST_DATA_DIR),
        spk='{folder}/NEST_single_stim_spikes-2001-0.gdf'.format(folder=NEST_DATA_DIR)

    shell:
        """
        source {{input.nest}}
        python {folder}/model.py -o {output_folder} --stim {{input.stim}} --reproduce {{input.repro}}
        """.format(folder=NEST_CODE_DIR,output_folder=NEST_DATA_DIR,data_folder=IZHI_DATA_DIR)
