ruleorder: nest_bitwise_reproduction > run_model
rule install_nest:
    output:
        expand('{nest_folder}/instl/bin/nest_vars.sh',nest_folder=NEST_SRC_DIR)
    params:
        nest_dir=NEST_SRC_DIR,
    shell:
        """
        cd {params.nest_dir}
        mkdir -p bld
        mkdir -p instl
        cd bld
        cmake -DCMAKE_INSTALL_PREFIX:PATH={params.nest_dir}/instl -Dwith-python=ON {params.nest_dir} -Dwith-mpi=ON
        make -j8
        make install
        """

rule run_model:
    output:
        weights= "{folder}/{{experiment}}_connectivity.json".format(folder=NEST_DATA_DIR),
        spikes=expand("{folder}/{{experiment}}_spikes-1001-0.gdf",folder=NEST_DATA_DIR),

    input:
        model='{folder}/model.py'.format(folder=NEST_CODE_DIR),
        conf='{folder}/experiments/{{experiment}}.yaml'.format(folder=NEST_CODE_DIR),
        nest=rules.install_nest.output
    log: 'logs/nest_{experiment}.log'
    shell:
        """
        source {{input.nest}}
        python {folder}/model.py -c {{input.conf}} &>{{log}}
        """.format(folder=NEST_CODE_DIR)


rule nest_bitwise_reproduction:
    input:
        model='{folder}/model.py'.format(folder=NEST_CODE_DIR),
        nest=rules.install_nest.output,
        repro= expand('{folder}/reformat_bitwise_reproduction_connectivity.json',folder=IZHI_DATA_DIR),
        stim=rules.original_bitwise_reproduction.output.stim,
        init=rules.original_bitwise_reproduction.output.init,
        conf='{folder}/experiments/{{experiment}}_reproduction.yaml'.format(folder=NEST_CODE_DIR)

    output:
        mem='{folder}/{{experiment}}_reproduction-1002-0.dat'.format(folder=NEST_DATA_DIR),
        spikes=expand("{folder}/{{experiment}}_reproduction_spikes-1001-0.gdf",folder=NEST_DATA_DIR),
        weights=expand("{folder}/{{experiment}}_reproduction_connectivity.json",folder=NEST_DATA_DIR)
    #priority:1
    log: 'logs/nest_{experiment}_reproduction.log'

    shell:
        """
        source {{input.nest}}
        python {folder}/model.py -c {{input.conf}} &>{{log}}
        """.format(folder=NEST_CODE_DIR)
